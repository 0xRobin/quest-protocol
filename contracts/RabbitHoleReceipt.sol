// SPDX-License-Identifier: MIT
pragma solidity ^0.8.15;

import "@openzeppelin/contracts-upgradeable/token/ERC721/ERC721Upgradeable.sol";
import "@openzeppelin/contracts-upgradeable/token/ERC721/extensions/ERC721URIStorageUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/token/ERC721/extensions/ERC721EnumerableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/utils/Base64Upgradeable.sol";
import "@openzeppelin/contracts-upgradeable/interfaces/IERC2981Upgradeable.sol";
import "@openzeppelin/contracts-upgradeable/utils/CountersUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/utils/StringsUpgradeable.sol";

contract RabbitHoleReceipt is Initializable, ERC721Upgradeable, ERC721EnumerableUpgradeable, ERC721URIStorageUpgradeable, OwnableUpgradeable, IERC2981Upgradeable {
    using CountersUpgradeable for CountersUpgradeable.Counter;
    using StringsUpgradeable for uint256;
    CountersUpgradeable.Counter private _tokenIds;

    mapping(uint => string) public questIdForTokenId;
    address public royaltyRecipient;
    address public minterAddress;
    uint public royaltyFee;

    /// @custom:oz-upgrades-unsafe-allow constructor
    constructor() {
        _disableInitializers();
    }

    function initialize(address royaltyRecipient_, address minterAddress_, uint royaltyFee_) initializer public {
        __ERC721_init("RabbitHoleReceipt", "RHR");
        __ERC721URIStorage_init();
        __Ownable_init();
        royaltyRecipient = royaltyRecipient_;
        minterAddress = minterAddress_;
        royaltyFee = royaltyFee_;
    }

    modifier onlyMinter() {
        msg.sender == minterAddress;
        _;
    }

    function setRoyaltyRecipient(address royaltyRecipient_) public onlyOwner {
        royaltyRecipient = royaltyRecipient_;
    }

    function setMinterAddress(address minterAddress_) public onlyOwner {
        minterAddress = minterAddress_;
    }

    function setRoyaltyFee(uint256 _royaltyFee) public onlyOwner {
        royaltyFee = _royaltyFee;
    }

    function _mintSingleNFT(string memory _questId) private {
        _tokenIds.increment();
        uint newTokenID = _tokenIds.current();
        _safeMint(msg.sender, newTokenID);
        questIdForTokenId[newTokenID] = _questId;
    }

    function mint(uint _count, string memory _questId) onlyMinter public {
        for (uint i = 0; i < _count; i++) {
            _mintSingleNFT(_questId);
        }
    }

    function getOwnedTokenIdsOfQuest(string memory _questId, address claimingAddress) public view returns (uint[] memory) {
        uint msgSenderBalance = balanceOf(claimingAddress);
        uint[] memory tokenIdsForQuest = new uint[](msgSenderBalance);
        uint foundTokens = 0;

        for (uint i = 0; i < msgSenderBalance; i++) {
            uint tokenId = tokenOfOwnerByIndex(claimingAddress, i);
            if( keccak256(bytes(questIdForTokenId[tokenId])) == keccak256(bytes(_questId)) ){
                tokenIdsForQuest[i] = tokenId;
                foundTokens++;
            }
        }

        uint[] memory filteredTokens = new uint[](foundTokens);
        uint filterTokensIndexTracker = 0;

        for (uint i = 0; i < msgSenderBalance; i++) {
            if (tokenIdsForQuest[i] > 0) {
                filteredTokens[filterTokensIndexTracker] = tokenIdsForQuest[i];
                filterTokensIndexTracker++;
            }
        }
        return filteredTokens;
    }

    function _burn(uint256 tokenId)
        internal
        override(ERC721Upgradeable, ERC721URIStorageUpgradeable)
    {
        super._burn(tokenId);
    }

    function _beforeTokenTransfer(address from, address to, uint256 tokenId, uint256 batchSize)
        internal
        override(ERC721Upgradeable, ERC721EnumerableUpgradeable)
    {
        super._beforeTokenTransfer(from, to, tokenId, batchSize);
    }

    function tokenURI(uint256 _tokenId)
        public
        view
        virtual
        override(ERC721Upgradeable, ERC721URIStorageUpgradeable)
        returns (string memory)
    {
        require(
            _exists(_tokenId),
            "ERC721URIStorage: URI query for nonexistent token"
        );

        bytes memory dataURI = abi.encodePacked(
            '{',
                '"name": "RabbitHole Quest #', questIdForTokenId[_tokenId] ,' Redeemer #', _tokenId.toString(), '",',
                '"description": "This is a receipt for a RabbitHole Quest. You can use this receipt to claim a reward on RabbitHole.",',
                '"image": "', generateSVG(), '"',
            '}'
        );
        return string(
            abi.encodePacked(
                "data:application/json;base64,",
                Base64Upgradeable.encode(dataURI)
            )
        );
    }

    function generateSVG() public pure returns(string memory){
        bytes memory svg = abi.encodePacked(
'<svg width="1500" height="1500" viewBox="0 0 1500 1500" fill="none" xmlns="http://www.w3.org/2000/svg">',
'<rect width="1500" height="1500" rx="41.6667" fill="url(#paint0_linear_9219_238)"/>',
'<path d="M78.176 1352H82.528L77.408 1342.66C80.576 1341.89 82.528 1339.42 82.528 1336.19C82.528 1332.35 79.808 1329.31 75.424 1329.31H66.72V1352H70.592V1343.04H73.408L78.176 1352ZM70.592 1339.65V1332.7H74.72C77.088 1332.7 78.624 1334.08 78.624 1336.19C78.624 1338.27 77.088 1339.65 74.72 1339.65H70.592ZM88.367 1342.5C88.495 1340.83 89.839 1339.04 92.175 1339.04C94.735 1339.04 95.951 1340.67 96.015 1342.5H88.367ZM96.431 1346.56C95.919 1348.1 94.767 1349.28 92.527 1349.28C90.223 1349.28 88.367 1347.58 88.271 1345.22H99.663C99.695 1345.15 99.759 1344.64 99.759 1344.03C99.759 1339.1 96.943 1335.94 92.143 1335.94C88.207 1335.94 84.559 1339.2 84.559 1344.13C84.559 1349.41 88.303 1352.48 92.527 1352.48C96.271 1352.48 98.735 1350.27 99.567 1347.55L96.431 1346.56ZM105.802 1344.16C105.802 1341.18 107.594 1339.3 110.026 1339.3C112.458 1339.3 114.122 1341.15 114.122 1344.13C114.122 1347.1 112.426 1349.12 109.994 1349.12C107.466 1349.12 105.802 1347.14 105.802 1344.16ZM117.706 1328.83H114.09V1338.24C113.61 1337.25 112.234 1336 109.514 1336C105.13 1336 102.09 1339.68 102.09 1344.16C102.09 1348.86 105.098 1352.38 109.578 1352.38C111.786 1352.38 113.418 1351.3 114.154 1349.98C114.154 1350.62 114.25 1351.65 114.314 1352H117.866C117.834 1351.74 117.706 1350.56 117.706 1349.15V1328.83ZM125.148 1342.5C125.276 1340.83 126.62 1339.04 128.956 1339.04C131.516 1339.04 132.732 1340.67 132.796 1342.5H125.148ZM133.212 1346.56C132.7 1348.1 131.548 1349.28 129.308 1349.28C127.004 1349.28 125.148 1347.58 125.052 1345.22H136.444C136.476 1345.15 136.54 1344.64 136.54 1344.03C136.54 1339.1 133.724 1335.94 128.924 1335.94C124.988 1335.94 121.34 1339.2 121.34 1344.13C121.34 1349.41 125.084 1352.48 129.308 1352.48C133.052 1352.48 135.516 1350.27 136.348 1347.55L133.212 1346.56ZM142.68 1342.5C142.808 1340.83 144.152 1339.04 146.488 1339.04C149.048 1339.04 150.264 1340.67 150.328 1342.5H142.68ZM150.744 1346.56C150.232 1348.1 149.08 1349.28 146.84 1349.28C144.536 1349.28 142.68 1347.58 142.584 1345.22H153.976C154.008 1345.15 154.072 1344.64 154.072 1344.03C154.072 1339.1 151.256 1335.94 146.456 1335.94C142.52 1335.94 138.872 1339.2 138.872 1344.13C138.872 1349.41 142.616 1352.48 146.84 1352.48C150.584 1352.48 153.048 1350.27 153.88 1347.55L150.744 1346.56ZM161.299 1352V1342.75C161.299 1340.77 162.547 1339.3 164.531 1339.3C166.643 1339.3 167.539 1340.7 167.539 1342.5V1352H171.187V1342.75C171.187 1340.83 172.467 1339.3 174.419 1339.3C176.499 1339.3 177.427 1340.67 177.427 1342.5V1352H181.011V1341.89C181.011 1337.76 178.323 1335.97 175.507 1335.97C173.491 1335.97 171.667 1336.67 170.451 1338.72C169.619 1336.9 167.827 1335.97 165.779 1335.97C164.019 1335.97 162.067 1336.8 161.171 1338.4V1336.42H157.619V1352H161.299ZM188.148 1342.5C188.276 1340.83 189.62 1339.04 191.956 1339.04C194.516 1339.04 195.732 1340.67 195.796 1342.5H188.148ZM196.212 1346.56C195.7 1348.1 194.548 1349.28 192.308 1349.28C190.004 1349.28 188.148 1347.58 188.052 1345.22H199.444C199.476 1345.15 199.54 1344.64 199.54 1344.03C199.54 1339.1 196.724 1335.94 191.924 1335.94C187.988 1335.94 184.34 1339.2 184.34 1344.13C184.34 1349.41 188.084 1352.48 192.308 1352.48C196.052 1352.48 198.516 1350.27 199.348 1347.55L196.212 1346.56ZM212.208 1336.32C212.048 1336.29 211.664 1336.22 211.216 1336.22C209.168 1336.22 207.44 1337.22 206.704 1338.91V1336.42H203.088V1352H206.8V1344.58C206.8 1341.66 208.112 1340 210.992 1340C211.376 1340 211.792 1340.03 212.208 1340.1V1336.32ZM229.652 1344.29V1340.99H220.628V1344.29H229.652ZM242.686 1341.63C242.686 1339.01 243.134 1336.99 244.158 1335.71C244.862 1334.78 245.854 1334.18 247.358 1334.18C248.862 1334.18 249.822 1334.78 250.558 1335.71C251.55 1336.99 251.998 1339.01 251.998 1341.63C251.998 1344.26 251.55 1346.27 250.558 1347.55C249.822 1348.48 248.862 1349.09 247.358 1349.09C245.854 1349.09 244.862 1348.48 244.158 1347.55C243.166 1346.27 242.686 1344.26 242.686 1341.63ZM238.878 1341.63C238.878 1344.38 239.326 1346.98 240.734 1349.09C242.078 1351.1 244.254 1352.48 247.358 1352.48C250.462 1352.48 252.606 1351.1 253.95 1349.09C255.358 1346.98 255.806 1344.38 255.806 1341.63C255.806 1338.88 255.358 1336.29 253.95 1334.18C252.606 1332.16 250.462 1330.78 247.358 1330.78C244.254 1330.78 242.078 1332.16 240.734 1334.18C239.326 1336.29 238.878 1338.88 238.878 1341.63ZM262.404 1341.63C262.404 1339.01 262.852 1336.99 263.876 1335.71C264.58 1334.78 265.572 1334.18 267.076 1334.18C268.58 1334.18 269.54 1334.78 270.276 1335.71C271.268 1336.99 271.716 1339.01 271.716 1341.63C271.716 1344.26 271.268 1346.27 270.276 1347.55C269.54 1348.48 268.58 1349.09 267.076 1349.09C265.572 1349.09 264.58 1348.48 263.876 1347.55C262.884 1346.27 262.404 1344.26 262.404 1341.63ZM258.596 1341.63C258.596 1344.38 259.044 1346.98 260.452 1349.09C261.796 1351.1 263.972 1352.48 267.076 1352.48C270.18 1352.48 272.324 1351.1 273.668 1349.09C275.076 1346.98 275.524 1344.38 275.524 1341.63C275.524 1338.88 275.076 1336.29 273.668 1334.18C272.324 1332.16 270.18 1330.78 267.076 1330.78C263.972 1330.78 261.796 1332.16 260.452 1334.18C259.044 1336.29 258.596 1338.88 258.596 1341.63ZM282.123 1341.63C282.123 1339.01 282.571 1336.99 283.595 1335.71C284.299 1334.78 285.291 1334.18 286.795 1334.18C288.299 1334.18 289.259 1334.78 289.995 1335.71C290.987 1336.99 291.435 1339.01 291.435 1341.63C291.435 1344.26 290.987 1346.27 289.995 1347.55C289.259 1348.48 288.299 1349.09 286.795 1349.09C285.291 1349.09 284.299 1348.48 283.595 1347.55C282.603 1346.27 282.123 1344.26 282.123 1341.63ZM278.315 1341.63C278.315 1344.38 278.763 1346.98 280.171 1349.09C281.515 1351.1 283.691 1352.48 286.795 1352.48C289.899 1352.48 292.043 1351.1 293.387 1349.09C294.795 1346.98 295.243 1344.38 295.243 1341.63C295.243 1338.88 294.795 1336.29 293.387 1334.18C292.043 1332.16 289.899 1330.78 286.795 1330.78C283.691 1330.78 281.515 1332.16 280.171 1334.18C278.763 1336.29 278.315 1338.88 278.315 1341.63Z" fill="#B1B1CD"/>',
'<path d="M65.344 1277.64C65.344 1285.1 70.912 1289.48 76.864 1289.48C78.944 1289.48 81.024 1288.94 82.784 1287.91L85.568 1290.95L88.16 1288.74L85.472 1285.74C87.264 1283.75 88.416 1281 88.416 1277.64C88.416 1270.22 82.816 1265.83 76.864 1265.83C70.912 1265.83 65.344 1270.22 65.344 1277.64ZM69.28 1277.64C69.28 1272.17 73.056 1269.45 76.864 1269.45C80.704 1269.45 84.48 1272.17 84.48 1277.64C84.48 1279.85 83.872 1281.58 82.912 1282.89L79.136 1278.7L76.512 1280.94L80.256 1285.1C79.2 1285.61 78.016 1285.83 76.864 1285.83C73.056 1285.83 69.28 1283.11 69.28 1277.64ZM102.232 1287.27C102.232 1287.91 102.296 1288.65 102.36 1289H105.912C105.847 1288.42 105.752 1287.43 105.752 1286.15V1273.42H102.04V1282.63C102.04 1284.68 100.92 1286.12 98.7755 1286.12C96.5355 1286.12 95.6395 1284.49 95.6395 1282.57V1273.42H91.9275V1283.24C91.9275 1286.7 94.1035 1289.45 97.8155 1289.45C99.6395 1289.45 101.464 1288.68 102.232 1287.27ZM113.055 1279.5C113.183 1277.83 114.527 1276.04 116.863 1276.04C119.423 1276.04 120.639 1277.67 120.703 1279.5H113.055ZM121.119 1283.56C120.607 1285.1 119.455 1286.28 117.215 1286.28C114.911 1286.28 113.055 1284.58 112.959 1282.22H124.351C124.383 1282.15 124.447 1281.64 124.447 1281.03C124.447 1276.1 121.631 1272.94 116.831 1272.94C112.895 1272.94 109.247 1276.2 109.247 1281.13C109.247 1286.41 112.991 1289.48 117.215 1289.48C120.959 1289.48 123.423 1287.27 124.255 1284.55L121.119 1283.56ZM126.618 1284.78C126.81 1286.54 128.538 1289.48 133.05 1289.48C137.018 1289.48 138.938 1286.86 138.938 1284.49C138.938 1282.18 137.402 1280.39 134.458 1279.75L132.09 1279.27C131.13 1279.08 130.522 1278.47 130.522 1277.64C130.522 1276.68 131.45 1275.85 132.762 1275.85C134.842 1275.85 135.514 1277.29 135.642 1278.18L138.778 1277.29C138.522 1275.75 137.114 1272.94 132.762 1272.94C129.53 1272.94 127.034 1275.24 127.034 1277.96C127.034 1280.1 128.474 1281.9 131.226 1282.5L133.53 1283.02C134.778 1283.27 135.354 1283.91 135.354 1284.74C135.354 1285.7 134.554 1286.54 133.018 1286.54C131.034 1286.54 129.978 1285.29 129.85 1283.88L126.618 1284.78ZM147.323 1268.65H143.963V1270.98C143.963 1272.36 143.227 1273.42 141.563 1273.42H140.763V1276.71H143.643V1284.55C143.643 1287.46 145.435 1289.19 148.315 1289.19C149.659 1289.19 150.363 1288.94 150.587 1288.84V1285.77C150.427 1285.8 149.819 1285.9 149.307 1285.9C147.931 1285.9 147.323 1285.32 147.323 1283.94V1276.71H150.555V1273.42H147.323V1268.65ZM158.53 1289V1266.31H154.626V1289H158.53ZM167.81 1285.48V1269.83H171.874C175.81 1269.83 179.042 1272.39 179.042 1277.7C179.042 1282.95 175.778 1285.48 171.842 1285.48H167.81ZM171.97 1289C178.114 1289 183.042 1284.97 183.042 1277.7C183.042 1270.41 178.178 1266.31 172.002 1266.31H163.97V1289H171.97ZM201.152 1281.29V1277.99H192.128V1281.29H201.152ZM214.186 1278.63C214.186 1276.01 214.634 1273.99 215.658 1272.71C216.362 1271.78 217.354 1271.18 218.858 1271.18C220.362 1271.18 221.322 1271.78 222.058 1272.71C223.05 1273.99 223.498 1276.01 223.498 1278.63C223.498 1281.26 223.05 1283.27 222.058 1284.55C221.322 1285.48 220.362 1286.09 218.858 1286.09C217.354 1286.09 216.362 1285.48 215.658 1284.55C214.666 1283.27 214.186 1281.26 214.186 1278.63ZM210.378 1278.63C210.378 1281.38 210.826 1283.98 212.234 1286.09C213.578 1288.1 215.754 1289.48 218.858 1289.48C221.962 1289.48 224.106 1288.1 225.45 1286.09C226.858 1283.98 227.306 1281.38 227.306 1278.63C227.306 1275.88 226.858 1273.29 225.45 1271.18C224.106 1269.16 221.962 1267.78 218.858 1267.78C215.754 1267.78 213.578 1269.16 212.234 1271.18C210.826 1273.29 210.378 1275.88 210.378 1278.63ZM233.904 1278.63C233.904 1276.01 234.352 1273.99 235.376 1272.71C236.08 1271.78 237.072 1271.18 238.576 1271.18C240.08 1271.18 241.04 1271.78 241.776 1272.71C242.768 1273.99 243.216 1276.01 243.216 1278.63C243.216 1281.26 242.768 1283.27 241.776 1284.55C241.04 1285.48 240.08 1286.09 238.576 1286.09C237.072 1286.09 236.08 1285.48 235.376 1284.55C234.384 1283.27 233.904 1281.26 233.904 1278.63ZM230.096 1278.63C230.096 1281.38 230.544 1283.98 231.952 1286.09C233.296 1288.1 235.472 1289.48 238.576 1289.48C241.68 1289.48 243.824 1288.1 245.168 1286.09C246.576 1283.98 247.024 1281.38 247.024 1278.63C247.024 1275.88 246.576 1273.29 245.168 1271.18C243.824 1269.16 241.68 1267.78 238.576 1267.78C235.472 1267.78 233.296 1269.16 231.952 1271.18C230.544 1273.29 230.096 1275.88 230.096 1278.63ZM253.623 1278.63C253.623 1276.01 254.071 1273.99 255.095 1272.71C255.799 1271.78 256.791 1271.18 258.295 1271.18C259.799 1271.18 260.759 1271.78 261.495 1272.71C262.487 1273.99 262.935 1276.01 262.935 1278.63C262.935 1281.26 262.487 1283.27 261.495 1284.55C260.759 1285.48 259.799 1286.09 258.295 1286.09C256.791 1286.09 255.799 1285.48 255.095 1284.55C254.103 1283.27 253.623 1281.26 253.623 1278.63ZM249.815 1278.63C249.815 1281.38 250.263 1283.98 251.671 1286.09C253.015 1288.1 255.191 1289.48 258.295 1289.48C261.399 1289.48 263.543 1288.1 264.887 1286.09C266.295 1283.98 266.743 1281.38 266.743 1278.63C266.743 1275.88 266.295 1273.29 264.887 1271.18C263.543 1269.16 261.399 1267.78 258.295 1267.78C255.191 1267.78 253.015 1269.16 251.671 1271.18C250.263 1273.29 249.815 1275.88 249.815 1278.63Z" fill="#B1B1CD"/>',
'<path d="M936.348 103.44C935.324 98.32 931.1 91.664 920.092 91.664C911.516 91.664 904.284 97.808 904.284 105.872C904.284 112.72 908.956 117.392 916.188 118.864L922.524 120.144C926.044 120.848 928.028 122.896 928.028 125.52C928.028 128.72 925.404 131.088 920.668 131.088C914.268 131.088 911.132 127.056 910.748 122.576L902.556 124.752C903.26 131.216 908.572 138.96 920.604 138.96C931.164 138.96 936.988 131.92 936.988 124.944C936.988 118.544 932.572 113.168 924.316 111.568L917.98 110.352C914.652 109.712 913.052 107.728 913.052 105.232C913.052 102.224 915.868 99.472 920.156 99.472C925.916 99.472 927.964 103.376 928.412 105.872L936.348 103.44ZM960.146 106.512L953.298 126.736L947.474 106.512H938.514L948.562 138H957.202L964.434 116.496L971.794 138H980.306L990.162 106.512H981.714L975.89 126.8L969.106 106.512H960.146ZM992.793 129.424C992.793 134.352 996.889 138.896 1003.61 138.896C1008.28 138.896 1011.29 136.72 1012.89 134.224C1012.89 135.44 1013.02 137.168 1013.21 138H1021.02C1020.82 136.912 1020.63 134.672 1020.63 133.008V117.52C1020.63 111.184 1016.92 105.552 1006.94 105.552C998.489 105.552 993.945 110.992 993.433 115.92L1000.98 117.52C1001.24 114.768 1003.29 112.4 1007 112.4C1010.58 112.4 1012.31 114.256 1012.31 116.496C1012.31 117.584 1011.74 118.48 1009.94 118.736L1002.2 119.888C996.953 120.656 992.793 123.792 992.793 129.424ZM1005.4 132.56C1002.65 132.56 1001.3 130.768 1001.3 128.912C1001.3 126.48 1003.03 125.264 1005.21 124.944L1012.31 123.856V125.264C1012.31 130.832 1008.98 132.56 1005.4 132.56ZM1037.08 150.16V134.928C1038.62 137.04 1041.82 138.768 1046.17 138.768C1055.07 138.768 1061.02 131.728 1061.02 122.192C1061.02 112.848 1055.71 105.808 1046.49 105.808C1041.76 105.808 1038.24 107.92 1036.83 110.352V106.512H1028.57V150.16H1037.08ZM1052.64 122.256C1052.64 127.888 1049.18 131.152 1044.83 131.152C1040.48 131.152 1036.96 127.824 1036.96 122.256C1036.96 116.688 1040.48 113.424 1044.83 113.424C1049.18 113.424 1052.64 116.688 1052.64 122.256ZM1096.44 131.216C1092.28 131.216 1088.44 128.144 1088.44 122.256C1088.44 116.304 1092.28 113.296 1096.44 113.296C1100.6 113.296 1104.44 116.304 1104.44 122.256C1104.44 128.208 1100.6 131.216 1096.44 131.216ZM1096.44 105.552C1087.03 105.552 1079.92 112.528 1079.92 122.256C1079.92 131.92 1087.03 138.96 1096.44 138.96C1105.84 138.96 1112.95 131.92 1112.95 122.256C1112.95 112.528 1105.84 105.552 1096.44 105.552ZM1127.54 119.888C1127.54 116.24 1129.72 113.36 1133.43 113.36C1137.52 113.36 1139.25 116.112 1139.25 119.632V138H1147.76V118.16C1147.76 111.248 1144.18 105.68 1136.37 105.68C1132.98 105.68 1129.2 107.152 1127.28 110.416V106.512H1119.03V138H1127.54V119.888ZM1188.54 139.024C1198.26 139.024 1206.01 133.072 1206.01 121.936V92.624H1197.18V121.296C1197.18 127.248 1193.91 130.384 1188.54 130.384C1183.29 130.384 1179.96 127.248 1179.96 121.296V92.624H1171.13V121.936C1171.13 133.072 1178.87 139.024 1188.54 139.024ZM1222.87 119.888C1222.87 116.24 1225.05 113.36 1228.76 113.36C1232.85 113.36 1234.58 116.112 1234.58 119.632V138H1243.09V118.16C1243.09 111.248 1239.51 105.68 1231.7 105.68C1228.31 105.68 1224.53 107.152 1222.61 110.416V106.512H1214.36V138H1222.87V119.888ZM1259.6 138V106.512H1251.09V138H1259.6ZM1250.07 96.208C1250.07 99.024 1252.44 101.392 1255.32 101.392C1258.26 101.392 1260.56 99.024 1260.56 96.208C1260.56 93.264 1258.26 90.896 1255.32 90.896C1252.44 90.896 1250.07 93.264 1250.07 96.208ZM1265.39 129.232C1265.77 132.816 1269.04 138.96 1278.51 138.96C1286.77 138.96 1290.73 133.712 1290.73 128.592C1290.73 123.984 1287.6 120.208 1281.39 118.928L1276.91 117.968C1275.18 117.648 1274.03 116.688 1274.03 115.152C1274.03 113.36 1275.82 112.016 1278.06 112.016C1281.65 112.016 1282.99 114.384 1283.25 116.24L1290.35 114.64C1289.97 111.248 1286.96 105.552 1278 105.552C1271.21 105.552 1266.22 110.224 1266.22 115.856C1266.22 120.272 1268.97 123.92 1275.05 125.264L1279.21 126.224C1281.65 126.736 1282.61 127.888 1282.61 129.296C1282.61 130.96 1281.26 132.432 1278.45 132.432C1274.73 132.432 1272.88 130.128 1272.69 127.632L1265.39 129.232ZM1314.29 106.512L1307.45 126.736L1301.62 106.512H1292.66L1302.71 138H1311.35L1318.58 116.496L1325.94 138H1334.45L1344.31 106.512H1335.86L1330.04 126.8L1323.25 106.512H1314.29ZM1346.94 129.424C1346.94 134.352 1351.04 138.896 1357.76 138.896C1362.43 138.896 1365.44 136.72 1367.04 134.224C1367.04 135.44 1367.16 137.168 1367.36 138H1375.16C1374.97 136.912 1374.78 134.672 1374.78 133.008V117.52C1374.78 111.184 1371.07 105.552 1361.08 105.552C1352.64 105.552 1348.09 110.992 1347.58 115.92L1355.13 117.52C1355.39 114.768 1357.44 112.4 1361.15 112.4C1364.73 112.4 1366.46 114.256 1366.46 116.496C1366.46 117.584 1365.88 118.48 1364.09 118.736L1356.35 119.888C1351.1 120.656 1346.94 123.792 1346.94 129.424ZM1359.55 132.56C1356.8 132.56 1355.45 130.768 1355.45 128.912C1355.45 126.48 1357.18 125.264 1359.36 124.944L1366.46 123.856V125.264C1366.46 130.832 1363.13 132.56 1359.55 132.56ZM1391.23 150.16V134.928C1392.77 137.04 1395.97 138.768 1400.32 138.768C1409.22 138.768 1415.17 131.728 1415.17 122.192C1415.17 112.848 1409.86 105.808 1400.64 105.808C1395.9 105.808 1392.38 107.92 1390.98 110.352V106.512H1382.72V150.16H1391.23ZM1406.78 122.256C1406.78 127.888 1403.33 131.152 1398.98 131.152C1394.62 131.152 1391.1 127.824 1391.1 122.256C1391.1 116.688 1394.62 113.424 1398.98 113.424C1403.33 113.424 1406.78 116.688 1406.78 122.256Z" fill="#E2E2FA"/>',
'<g clip-path="url(#clip0_9219_238)" filter="url(#filter0_di_9219_238)">',
'<g filter="url(#filter1_d_9219_238)">',
'<path d="M974.84 644.426C974.84 593.255 874.174 551.77 750.007 551.77C625.84 551.77 525.174 593.255 525.174 644.426C525.174 670.839 552.118 694.608 595.132 711.484L584.34 959.457C584.34 959.457 585.086 1021.23 750.007 1021.23C914.928 1021.23 915.674 959.457 915.674 959.457L904.882 711.484C947.896 694.608 974.84 670.839 974.84 644.426Z" fill="#0C192B"/>',
'</g>',
'<path d="M750 601.188C712.339 601.188 676.221 605.092 649.591 612.043C622.961 618.993 608 628.42 608 638.25C608 648.08 622.961 657.507 649.591 664.457C676.221 671.408 712.339 675.313 750 675.313C787.661 675.313 823.779 671.408 850.409 664.457C877.039 657.507 892 648.08 892 638.25C892 628.42 877.039 618.993 850.409 612.043C823.779 605.092 787.661 601.188 750 601.188Z" fill="#212121"/>',
'<path d="M907.664 775.483L904.884 711.488C864.544 727.314 810.099 737.086 750.009 737.086C689.919 737.086 635.474 727.314 595.134 711.488L592.354 775.483C640.018 791.234 695.812 798.857 750.009 798.857C804.206 798.857 860 791.234 907.664 775.483Z" fill="url(#paint1_linear_9219_238)"/>',
'<g clip-path="url(#clip1_9219_238)">',
'<path d="M705.882 491.542C703.09 491.953 700.757 493.514 699.023 496.059C697.056 498.956 696.106 503.165 695.757 507.846C720.345 520.217 747.858 546.486 759.127 595.61C760.493 595.531 761.859 595.452 763.206 595.401C748.851 513.176 718.973 489.618 705.882 491.542ZM658.464 510.988C649.263 512.34 645.55 517.686 646.9 527.698C651.024 558.281 672.592 610.742 703.066 635.43C692.662 650.702 690.153 666.544 688.073 680.715C684.929 702.06 682.216 720.539 654.887 736.471C652.095 738.1 651.176 741.841 652.648 744.793C652.964 745.404 684.327 806.805 767.839 794.531C770.173 794.188 772.54 793.742 774.953 793.29C778.073 792.71 780.246 789.612 779.804 786.339C773.763 741.539 786.978 739.669 795.744 738.381C799.428 737.839 803.452 737.735 807.773 737.588C812.513 737.427 817.469 737.137 822.366 736.417C844.108 733.222 855.748 719.498 859.688 691.944C865.044 689.257 871.053 683.451 869.764 673.894C868.356 663.452 838.618 598.523 749.688 608.694C735.882 526.388 674.988 508.559 658.464 510.988ZM788.572 647.814C795.049 646.862 801.028 651.564 801.94 658.326C802.852 665.088 798.349 671.33 791.872 672.281C785.395 673.233 779.416 668.532 778.504 661.77C777.592 655.008 782.096 648.766 788.572 647.814Z" fill="#A1A4B1"/>',
'</g>',
'</g>',
'<defs>',
'<filter id="filter0_di_9219_238" x="436" y="464" width="628" height="653" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">',
'<feFlood flood-opacity="0" result="BackgroundImageFix"/>',
'<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>',
'<feOffset dy="4"/>',
'<feGaussianBlur stdDeviation="15"/>',
'<feComposite in2="hardAlpha" operator="out"/>',
'<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0"/>',
'<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_9219_238"/>',
'<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_9219_238" result="shape"/>',
'<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>',
'<feOffset dx="3" dy="3"/>',
'<feGaussianBlur stdDeviation="2"/>',
'<feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1"/>',
'<feColorMatrix type="matrix" values="0 0 0 0 0.552941 0 0 0 0 0.984314 0 0 0 0 0.788235 0 0 0 0.4 0"/>',
'<feBlend mode="normal" in2="shape" result="effect2_innerShadow_9219_238"/>',
'</filter>',
'<filter id="filter1_d_9219_238" x="495.174" y="525.77" width="509.667" height="529.459" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">',
'<feFlood flood-opacity="0" result="BackgroundImageFix"/>',
'<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>',
'<feOffset dy="4"/>',
'<feGaussianBlur stdDeviation="15"/>',
'<feComposite in2="hardAlpha" operator="out"/>',
'<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>',
'<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_9219_238"/>',
'<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_9219_238" result="shape"/>',
'</filter>',
'<linearGradient id="paint0_linear_9219_238" x1="1065.5" y1="1419.5" x2="202.5" y2="89.9999" gradientUnits="userSpaceOnUse">',
'<stop stop-color="#131317"/>',
'<stop offset="1" stop-color="#33323D"/>',
'</linearGradient>',
'<linearGradient id="paint1_linear_9219_238" x1="592.354" y1="711.488" x2="637.319" y2="873.766" gradientUnits="userSpaceOnUse">',
'<stop stop-color="#FF007A"/>',
'<stop offset="1" stop-color="#FA742B"/>',
'</linearGradient>',
'<clipPath id="clip0_9219_238">',
'<rect width="568" height="593" fill="white" transform="translate(466 490)"/>',
'</clipPath>',
'<clipPath id="clip1_9219_238">',
'<rect width="296.092" height="308.606" fill="white" transform="matrix(0.989371 -0.145416 0.133637 0.99103 596.174 360.098)"/>',
'</clipPath>',
'</defs>',
'</svg>'
        );
        return string(
            abi.encodePacked(
                "data:image/svg+xml;base64,",
                Base64Upgradeable.encode(svg)
            )
        );
    }

    function royaltyInfo(uint256 tokenId, uint256 salePrice)
        external
        view
        override
        returns (address receiver, uint256 royaltyAmount)
    {
        require(_exists(tokenId), "Nonexistent token");

        uint256 royaltyPayment = (salePrice * royaltyFee) / 1000;
        return (royaltyRecipient, royaltyPayment);
    }

    function supportsInterface(bytes4 interfaceId)
        public
        view
        virtual
        override(ERC721Upgradeable, ERC721EnumerableUpgradeable, IERC165Upgradeable)
        returns (bool)
    {
        return
            interfaceId == type(IERC2981Upgradeable).interfaceId ||
            super.supportsInterface(interfaceId);
    }
}
